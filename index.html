<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="description" content="UNISEC Satellite Mapping" />
    <meta property="og:image" content=""
    />
    <meta property="og:description" content="UNISEC Satellite Mapping" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>UNISEC Satellite Mapping</title>
    <xhtml:link rel="alternate" hreflang="en-us" href="http://hiroshima.archiving.jp/index_en.html" />

    <link rel="SHORTCUT ICON" href="http://shinsai.mapping.jp/favicon.ico">
    <style>
        @import url(Cesium/Widgets/widgets.css);
    </style>
    <link rel="stylesheet" type="text/css" media="all" href="./css/style.css" />
    <link rel="stylesheet" type="text/css" media="all" href="./css/menubutton.css" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/slidein.js"></script>
    <script src="js/slidein2.js"></script>
    <script src="Cesium/Cesium.js"></script>
    <script src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-55397811-2', 'auto');
		ga('send', 'pageview');
    </script>
</head>

<body>
    <div class="geocode">
        <form action="javascript:geocode()" class="textbox" />
        <input id="inputtext" class="textbox" type="text" value="" placeholder="地名で検索" />
        </form>
    </div>
    <div id="blackOut">
        <img class="loading" src="data/loading.gif">
    </div>
    <div id="cesiumContainer"></div>
    <div id="button" class="general-button">
        <div class="button-content">
            <span class="icon-font">menu</span>
        </div>
    </div>
    <div id="button2" class="general-button" onclick="move2d();">
        <div class="button-content">
            <span class="icon-font">help</span>
        </div>
    </div>
    <div id="button3" class="general-button">
        <div class="button-content">
            <span class="icon-font">paramater</span>
        </div>
    </div>
    <div id="buttonGeo" class="general-button" onclick="flyToMyLocation();">
        <div class="button-content">
            <span class="icon-font">geo</span>
        </div>
    </div>
    <div id="slide_menu"></div>
    <div id="slide_menu2"></div>
    <div class="sharebutton">
        <ul class="share-buttons">
            <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fhiroshima.archiving.jp%2F&t=" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://hiroshima.archiving.jp/'); return false;"><img class="share" src="./data/flat_web_icon_set/color/Facebook.png"></a>
            </li>
            <li>
                <a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fhiroshima.archiving.jp%2F&text=:%20http%3A%2F%2Fhiroshima.archiving.jp%2F&via=hwtnv"
                target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ' http://hiroshima.archiving.jp/'); return false;"><img class="share" src="./data/flat_web_icon_set/color/Twitter.png"></a>
            </li>
            <li>
                <a href="https://plus.google.com/share?url=http%3A%2F%2Fhiroshima.archiving.jp%2F" target="_blank" title="Share on Google+"
                onclick="window.open('https://plus.google.com/share?url=http://hiroshima.archiving.jp/'); return false;"><img class="share" src="./data/flat_web_icon_set/color/Google+.png"></a>
            </li>
        </ul>
    </div>
    <script>

//端末種別と画面サイズ

var mobile = 0;
var smallScreen = 0;

var getDevice = (function(){
	var ua = navigator.userAgent;
	if(ua.indexOf('iPhone') > 0 || ua.indexOf('iPod') > 0 || ua.indexOf('Android') > 0 && ua.indexOf('Mobile') > 0){
		mobile = 1;
	}else if(ua.indexOf('iPad') > 0 || ua.indexOf('Android') > 0){
		mobile = 2;
	}else{
		mobile = 0;
	}
})();

var screenWidth = window.parent.screen.width;
if (screenWidth <= 640) {
	smallScreen = 1;
} else {
	smallScreen = 0;
}

if (smallScreen == 1) {
	$(function() {
		$('.sharebutton').css('right', '8px');
	});				
}

//スワイプによるスクロール禁止

var cesiumDiv = document.getElementById("cesiumContainer");

function preventScroll(event) {
  event.preventDefault();
}

cesiumDiv.addEventListener("gesturestart", preventScroll, false);
cesiumDiv.addEventListener("gesturechange", preventScroll, false);
cesiumDiv.addEventListener("gestureend", preventScroll, false);

//各種DIV

var blackOutDiv = document.getElementById("blackOut");

//視点作成配列

function viewPoints(_label, _lat, _lng, _heading, _pitch, _range) {
	this.label = _label;
	this.lat = _lat;
	this.lng = _lng;
	this.heading = _heading;
	this.pitch = _pitch;
	this.range = _range;
}

var viewPointsArray=[];
viewPointsArray[0]=new viewPoints("地球",35.87501683, 135.8878458, 0, -89, 20000000);

//視点メニュー作成

var viewPointChangeMenu = document.getElementById('slide_menu');
var dropDownList = "";

for (var i=0; i<viewPointsArray.length; i++) {
	dropDownList = dropDownList + '<li><a href="#" onclick = "changeViewPoint(' + i + ',' + '3.0);return false;">' + viewPointsArray[i].label + '</a></li>';
}

var viewPointChangeMenuHtml = '<ul class="viewpoint">' + dropDownList + '</li></ul>';
viewPointChangeMenu.innerHTML = viewPointChangeMenuHtml;


//CZML配列作成

function czmlData(_label, _url) {
	this.label = _label;
	this.url = _url;
}

var czmlDataArray=[];

czmlDataArray[0]=new czmlData("satellite",'data/czml/satellite.czml');

//ビューア初期化	

var viewer = new Cesium.Viewer('cesiumContainer',{
	imageryProvider : new Cesium.ArcGisMapServerImageryProvider({
		url : '//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
		enablePickFeatures : false
	}),
	navigationHelpButton : false,
	navigationInstructionsInitiallyVisible : false,
	geocoder:false,
	sceneModePicker:false,
	baseLayerPicker:false,
	scene3DOnly : true
});

//地形メッシュを設定
cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
  url : '//assets.agi.com/stk-terrain/world',
  requestWaterMask : true,
  requestVertexNormals : true
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

//太陽光を設定
viewer.scene.globe.enableLighting = true;

//フォグを設定
fog = new Cesium.Fog();
fog.density = 0.0005;
fog.screenSpaceErrorFactor = 100.0;

//起動シークエンス

fadeInOut(blackOutDiv,1);
setTimeout('fadeInOut(blackOutDiv,0)',2500);

$(function() {
	$('.cesium-widget-credits').css('display', 'none');
});

//初期視点

viewer.camera.flyTo({
  destination : Cesium.Cartesian3.fromDegrees(139.7621541,35.7143536,1000),
  duration : 0,
});

setTimeout('changeViewPoint(0,4)',3000);
setTimeout('fadeInOut(blackOutDiv,1)',7000);
setTimeout('loadCzml()',7000);

//CZMLロード

function loadCzml(){			
	var i = 0;
	var load = setInterval(function(){
		var promise = Cesium.CzmlDataSource.load(czmlDataArray[i].url);
		promise.then(function(dataSource) {
			viewer.dataSources.add(dataSource);
		}).otherwise(function(error){
			alert('CZMLデータが読み込めません');
		});
		i++;
		if (i == czmlDataArray.length){
			clearInterval(load);
            setTimeout('fadeInOut(blackOutDiv,0)',1000);
            setTimeout('timeSet()',1000);
		}
	}, 0);
}

//時間設定

var endISO = '2016-03-01T23:55:00Z';
var startISO = '2016-03-01T00:00:00Z';

function timeSet(){
	clock = new Cesium.Clock({
		startTime : Cesium.JulianDate.fromIso8601(startISO),
		currentTime : Cesium.JulianDate.fromIso8601(startISO),
		stopTime : Cesium.JulianDate.fromIso8601(endISO),
		clockRange : Cesium.ClockRange.LOOP_STOP
	});
	viewer.clock.startTime = clock.startTime;
	viewer.clock.stopTime = clock.stopTime;
	viewer.clock.currentTime = clock.currentTime;
	viewer.clock.multiplier = 10 * 20;
	viewer.timeline.zoomTo(viewer.clock.startTime, viewer.clock.stopTime);
}

//視点移動

function changeViewPoint(num, delay) {
	var newLat = viewPointsArray[num].lat;
	var newLng = viewPointsArray[num].lng;
	var newHeading = Cesium.Math.toRadians(viewPointsArray[num].heading);
	var newPitch = Cesium.Math.toRadians(viewPointsArray[num].pitch);
	var newRange = viewPointsArray[num].range;
	
	var center = Cesium.Cartesian3.fromDegrees(newLng, newLat);
	var boundingSphere = new Cesium.BoundingSphere(center, newRange);
	var headingPitchRange = new Cesium.HeadingPitchRange(newHeading, newPitch, newRange);
	
	viewer.camera.constrainedAxis = Cesium.Cartesian3.UNIT_Z;
	viewer.camera.flyToBoundingSphere(boundingSphere,{
		duration : delay,
		offset : headingPitchRange,
		easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
	});
}

//ジオコード

function geocode() {
	var geocoder = new google.maps.Geocoder();
	var input = document.getElementById('inputtext').value;
	geocoder.geocode(
		{ address:input },

		function( results, status ) {
			if( status == google.maps.GeocoderStatus.OK ) {
				var viewportObj = results[0].geometry.viewport;
				var southNorth = viewportObj[Object.keys(viewportObj)[0]];
				var westEast = viewportObj[Object.keys(viewportObj)[1]];

				var south = southNorth[Object.keys(southNorth)[0]];
				var north = southNorth[Object.keys(southNorth)[1]];
				var west = westEast[Object.keys(westEast)[0]];
				var east = westEast[Object.keys(westEast)[1]];		
				var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);
				viewer.camera.flyTo({
					destination : rectangle,
					easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
				});
			} else {
				alert('見つかりません');
			}
		} 
		);
}

//現在地へ移動

function flyToMyLocation() {
	function fly(position) {
		viewer.camera.flyTo({
			destination : Cesium.Cartesian3.fromDegrees(position.coords.longitude, position.coords.latitude, 7500000),
			easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
		});
	}
	navigator.geolocation.getCurrentPosition(fly);
}

//ヘルプ

function move2d(){
	window.open('http://hiroshima.mapping.jp/index_jp.html');
}

//DIVのフェードイン・アウト	

function fadeInOut(layer,param) {
	if (param == 0){
		$(function() {
			$(layer).fadeOut("slow");
		});
		viewer.trackedEntity = undefined;
	} else {
		$(function() {
			$(layer).fadeIn("slow");
		});
	} 
}
    </script>
</body>

</html>